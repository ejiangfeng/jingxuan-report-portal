# 鲸选自助报表平台需求文档

**项目地址**: https://github.com/ejiangfeng/jingxuan-report-portal

**数据库**: OceanBase (t5e434t9rgh4w.cn-hangzhou.oceanbase.aliyuncs.com)

**文档更新日期**: 2026-02-25

---

## 📋 目录

1. [项目概述](#项目概述)
2. [功能需求](#功能需求)
3. [报表列表](#报表列表)
4. [技术实现](#技术实现)
5. [部署说明](#部署说明)
6. [使用指南](#使用指南)
7. [变更记录](#变更记录)

---

## 项目概述

### 项目背景
鲸选自助报表平台是一个基于 Web 的数据查询和导出系统，为业务人员提供便捷的订单、商品、用户等数据查询和导出功能。

### 核心需求
- **数据量支持**: 支持 10 万 + 条记录的查询和导出
- **导出格式**: Excel 格式，大数据量时自动分割为多个 CSV 并打包成 ZIP
- **数据源**: OceanBase 真实数据库
- **时区处理**: 使用北京时间 (UTC+8) 显示

### 技术栈
- **前端**: HTML + CSS + JavaScript (原生)
- **后端**: Node.js + Express
- **数据库**: OceanBase (MySQL 兼容)
- **部署**: Docker + Docker Compose
- **Web 服务器**: Nginx

---

## 功能需求

### 1. 订单查询
**需求描述**: 查询订单数据，支持多条件筛选和分页

**筛选条件**:
- 下单日期范围（必填）
- 门店代码（可选，支持多个，逗号分隔）
- 下单人手机号（可选）
- 商品编码（可选）
- 订单状态（可选，下拉选择）

**显示字段**:
- 订单号、来源渠道、下单人手机号、订单类型、订单状态
- 下单时间、所属门店名称、所属门店代码、配送方式
- 收货人信息、商品种类数、商品总数量
- 商品总金额、优惠总金额、实付商品总金额
- 运费信息、包装费、客户实付金额
- 支付方式明细（支付宝、微信、储值卡等）
- 优惠券信息

**功能**:
- ✅ 分页查询（默认每页 10 条）
- ✅ 导出订单（支持全量导出）
- ✅ 导出订单明细（支持全量导出）
- ✅ 清空筛选条件

**数据量**: 15 万 + 条记录

---

### 2. 商品渗透率报表
**需求描述**: 分析商品在订单中的渗透情况

**筛选条件**:
- 查询日期范围（必填）
- 门店代码（可选，默认 2625）
- 商品条码（可选）
- 商品编码（可选）

**显示字段** (18 个):
- 大类编码、大类名称、商品编码、商品条码、商品名称、规格
- 石基 SKU 编码、石基 SPU 编码
- 购买数量、商品订单量、商品去重用户数
- 大类订单量、商品大类订单渗透率、大类去重用户数
- 商品大类用户渗透率、全局订单量
- 商品全局订单渗透率、全局去重用户数
- 商品全局用户渗透率

**渗透率计算**:
- **商品大类订单渗透率** = 该商品订单量 / 同大类订单总量 × 100%
- **商品大类用户渗透率** = 该商品用户数 / 同大类用户总数 × 100%
- **商品全局订单渗透率** = 该商品订单量 / 全局订单总量 × 100%
- **商品全局用户渗透率** = 该商品用户数 / 全局用户总数 × 100%

**功能**:
- ✅ 分页查询（默认每页 20 条）
- ✅ 导出 Excel（支持全量导出）
- ✅ 自动初始化日期（T-2 到 T-1）

**数据量**: 3,862 个商品（示例）

**参考 SQL**: 《商品渗透率报表.sql》

---

### 3. 优惠券领用核销查询
**需求描述**: 查询优惠券的领用和核销情况

**筛选条件**:
- 领用开始日期、领用结束日期（至少填一项）
- 核销开始日期、核销结束日期（可选）
- 优惠券 ID（可选，支持多个，逗号分隔）

**显示字段**:
- 用户手机号、优惠券 ID、优惠券名称
- 领券时间、生效时间、失效时间
- 订单编号、配送方式、下单时间
- 实付商品总金额、商品总金额、优惠总金额
- 运费活动优惠金额、门店编码、门店名称

**功能**:
- ✅ 分页查询（默认每页 20 条）
- ✅ 导出 Excel（支持全量导出）
- ✅ 显示执行时间

**数据量**: 57 万 + 条记录

**参考 SQL**: 《优惠券领用核销查询.sql》

---

### 4. 免运活动查询
**需求描述**: 查询免运活动相关的订单

**筛选条件**:
- 下单日期范围（必填）
- 门店代码（可选）

**显示字段**:
- 活动 ID、活动名称、订单编号
- 下单时间、门店编码、门店名称

**功能**:
- ✅ 分页查询（默认每页 20 条）
- ✅ 导出 Excel（支持全量导出）

**参考 SQL**: 《免运活动查询.sql》

---

### 5. 社群拉新查询
**需求描述**: 查询社群拉新活动的助力记录

**筛选条件**:
- 活动日期范围（必填）
- 活动 ID（可选，默认 32，支持多个，逗号分隔）

**显示字段**:
- 活动 ID、活动名称、发起 ID、发起用户 ID
- 用户手机、助力用户 ID、助力用户手机
- 助力时间、更新时间、状态、失败原因

**功能**:
- ✅ 分页查询（默认每页 20 条）
- ✅ 导出 Excel（支持全量导出）

**数据量**: 示例数据

**参考 SQL**: 《社群拉新查询.sql》

---

### 6. 商城用户下单查询（新增）
**需求描述**: 查询在鲸选商城（station_id=127）下单的用户最近下单时间

**筛选条件**:
- 查询日期（必填，默认昨天）
- 手机号（可选，精确匹配）

**显示字段**:
- 手机号
- 最近下单时间（所有门店）
- 鲸选商城最近下单时间（station_id=127）

**功能**:
- ✅ 分页查询（默认每页 20 条）
- ✅ 导出 Excel（支持全量导出）
- ✅ 自动初始化日期为昨天

**数据量**: 实时查询

**参考 SQL**: 《商城最近下单.sql》

---

## 技术实现

### 1. 大数据量导出
**需求**: 支持超过 10 万条记录的导出

**实现方案**:
```javascript
// 分批次查询，每批 10 万条
const CHUNK_SIZE = 100000;

// 分批生成 CSV 文件
let offset = 0;
while (true) {
  const batchSql = SQL.replace('LIMIT ? OFFSET ?', 'LIMIT ? OFFSET ?');
  const [result] = await conn.query(batchSql, [...params, CHUNK_SIZE, offset]);
  if (result.length === 0) break;
  
  // 生成 CSV 文件
  await writeCSV(filePath, headers, result);
  
  offset += CHUNK_SIZE;
}

// 多个文件打包成 ZIP
await createZIP(csvFiles, zipPath, tempDir);
```

**导出逻辑**:
- ≤10 万条：单个 CSV 文件
- >10 万条：多个 CSV 文件 + ZIP 压缩包

**依赖**: `archiver` (NPM 包)

---

### 2. 时区处理
**问题**: OceanBase 返回的时间是 ISO UTC 格式（带 Z），但实际存储的是北京时间

**解决方案**:
```javascript
// 订单查询等数据库时间：减 8 小时
function formatDate(isoString) {
    const date = new Date(isoString);
    date.setHours(date.getHours() - 8);  // 减 8 小时
    return `${year}/${month}/${day} ${hours}:${minutes}`;
}

// 导出任务创建时间（真实 UTC）：加 8 小时
function formatExportTime(isoString) {
    const date = new Date(isoString);
    date.setHours(date.getHours() + 8);  // 加 8 小时
    return `${year}/${month}/${day} ${hours}:${minutes}`;
}
```

---

### 3. CSP 配置
**问题**: ExcelJS 库使用 `eval()`，被 CSP 阻止

**解决方案**: 移除 CSP 限制（开发环境）
```nginx
# nginx.conf
# add_header Content-Security-Policy ... (已注释)
```

**注意**: 生产环境建议重新启用 CSP，使用更精细的配置

---

### 4. 前端字段映射
**问题**: 后端返回 `data.items`，前端期望 `data.list`

**解决方案**: 统一使用 `data.items`
```javascript
// 所有报表统一
penData = result.data.items || [];
couponData = result.data.items || [];
freightData = result.data.items || [];
invitationData = result.data.items || [];
```

---

### 5. 缓存版本控制
**问题**: 浏览器缓存导致代码更新不生效

**解决方案**: URL 添加版本号
```html
<link rel="stylesheet" href="styles.css?v=20260225d">
<script src="app.js?v=20260225d"></script>
```

---

## 部署说明

### Docker 部署
```bash
# 启动服务
cd /Users/ejiangfeng/ai-jx-report/jingxuan-report-portal
docker-compose -f docker-compose.simple.yml up -d

# 查看日志
docker logs jingxuan-backend -f
docker logs jingxuan-frontend -f

# 重启服务
docker-compose -f docker-compose.simple.yml restart

# 重新构建
docker-compose -f docker-compose.simple.yml build --no-cache backend
docker-compose -f docker-compose.simple.yml up -d
```

### 服务端口
| 服务 | 容器名 | 端口 | 访问地址 |
|------|--------|------|---------|
| 前端 Nginx | jingxuan-frontend | 7788 | http://localhost:7788 |
| 后端 API | jingxuan-backend | 4000 | http://localhost:4000 |

### 环境变量
```bash
# backend/.env
DB_HOST=t5e434t9rgh4w.cn-hangzhou.oceanbase.aliyuncs.com
DB_PORT=3306
DB_USER=jxpt_query
DB_PASSWORD=your_password
DB_DATABASE=lianhua_b2c
DB_CONNECTION_LIMIT=50
PORT=4000
USE_MOCK_DATA=false  # false=真实数据，true=模拟数据
```

---

## 使用指南

### 1. 查询操作
1. 选择要查询的报表（点击顶部导航）
2. 填写筛选条件
3. 点击"查询报表"按钮
4. 查看查询结果（显示记录数、分页信息）

### 2. 导出操作
1. 填写筛选条件
2. 点击"导出查询结果"按钮
3. 等待导出完成提示
4. 点击"📋 导出任务"查看进度
5. 点击下载按钮下载文件

### 3. 导出时间参考
| 记录数 | 预计时间 | 文件格式 |
|--------|---------|---------|
| 1 万条 | 5-10 秒 | Excel (.xlsx) |
| 10 万条 | 30-60 秒 | Excel (.xlsx) |
| 50 万条 | 2-5 分钟 | Excel (.xlsx) |
| 100 万条 + | 5-10 分钟 | ZIP (多个 CSV) |

### 4. 常见问题
**Q: 点击查询没反应？**
- 强制刷新浏览器（Command+Shift+R）
- 检查浏览器控制台（F12）是否有错误
- 确认后端服务正常运行

**Q: 导出失败？**
- 检查筛选条件是否填写
- 确认数据量是否过大（建议先测试小范围）
- 查看导出任务列表的状态

**Q: 时间显示不对？**
- 已修复时区问题，刷新浏览器即可
- 订单时间：显示北京时间
- 导出任务创建时间：显示北京时间

---

## 变更记录

### 2026-02-25
#### 新增功能
- ✅ 商城用户下单查询（第 6 个报表）
- ✅ 大数据量导出支持（无 10 万条限制）
- ✅ 导出文件自动分割（每 10 万条一个 CSV）
- ✅ 多文件自动打包成 ZIP

#### 功能优化
- ✅ 所有报表支持真实数据库查询
- ✅ 统一导出按钮文字为"导出查询结果"
- ✅ 移除订单查询的供应商编码筛选条件
- ✅ 移除 CSP 限制以支持 ExcelJS

#### Bug 修复
- ✅ 修复时间显示时区问题（快/慢 8 小时）
- ✅ 修复前端字段映射问题（items vs list）
- ✅ 修复报表切换功能
- ✅ 修复优惠券导出 10 万条限制

#### Git 提交记录
```
b097c96 修复：商城用户下单报表页面切换逻辑
e00465c 新增：商城用户下单查询功能
770beef 移除：所有导出功能的 10 万条记录限制
33fb0fc 修复：时间显示时区问题
3e8c0ee 修复：导出任务创建时间显示为北京时间 (UTC+8)
5e11379 移除：订单查询中的供应商编码筛选条件
bc9fd10 移除 CSP 限制以支持 ExcelJS 导出功能
16591cc 修复：所有报表查询统一使用 items 字段匹配 API 返回
```

---

## 附录

### A. SQL 文件清单
| 文件名 | 用途 |
|--------|------|
| 《商品渗透率报表.sql》 | 商品渗透率查询 |
| 《优惠券领用核销查询.sql》 | 优惠券查询 |
| 《免运活动查询.sql》 | 免运活动查询 |
| 《社群拉新查询.sql》 | 社群拉新查询 |
| 《商城最近下单.sql》 | 商城用户下单查询 |
| 《订单查询.sql》 | 订单查询 |
| 《订单明细查询.sql》 | 订单明细查询 |

### B. 数据库表说明
| 表名 | 说明 |
|------|------|
| tz_order | 订单主表 |
| tz_order_item | 订单明细表 |
| tz_user | 用户表 |
| tz_station | 门店表 |
| tz_sku | 商品 SKU 表 |
| tz_prod | 商品表 |
| tz_coupon | 优惠券表 |
| tz_coupon_user | 优惠券用户关联表 |
| mas_category | 商品分类表 |
| mas_sku | 商品 SKU 扩展表 |

### C. 联系信息
- **项目仓库**: https://github.com/ejiangfeng/jingxuan-report-portal
- **数据库**: OceanBase (杭州)
- **部署方式**: Docker

---

**文档版本**: v1.0  
**最后更新**: 2026-02-25  
**维护人员**: Development Team
